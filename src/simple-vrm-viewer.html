<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple VRM Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: #212121;
      color: white;
    }
    #container {
      position: fixed;
      width: 100%;
      height: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 8px;
      z-index: 100;
    }
    .model-group {
      margin-bottom: 15px;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 8px 16px;
      margin: 5px 5px 5px 0;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #3e8e41;
    }
    button:active {
      background: #1b5e20;
    }
    .btn-group {
      margin-top: 10px;
    }
    .status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
    }
    .success {
      background: rgba(76, 175, 80, 0.3);
    }
    .error {
      background: rgba(244, 67, 54, 0.3);
    }
    .info {
      background: rgba(33, 150, 243, 0.3);
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="container"></div>
  
  <div id="controls">
    <h2>VRM Model Viewer</h2>
    
    <div class="model-group">
      <div>
        <button id="load-sample">Load Sample VRM</button>
        <button id="load-local">Load Local VRM</button>
      </div>
      <input type="file" id="file-input" accept=".vrm" style="display:none">
    </div>
    
    <div class="btn-group">
      <button id="toggle-rotation">Toggle Rotation</button>
      <button id="toggle-wireframe">Toggle Wireframe</button>
      <button id="reset-camera">Reset Camera</button>
    </div>
    
    <div id="status-container" style="display:none" class="status">
      <span id="spinner" class="spinner"></span>
      <span id="status-text">Loading model...</span>
    </div>
  </div>
  
  <!-- Load the bundled libraries -->
  <script src="../dist/vrm-bundle.js"></script>
  <script src="js/vrm-renderer.js"></script>
  
  <script>
    // DOM elements
    const container = document.getElementById('container');
    const loadSampleBtn = document.getElementById('load-sample');
    const loadLocalBtn = document.getElementById('load-local');
    const fileInput = document.getElementById('file-input');
    const toggleRotationBtn = document.getElementById('toggle-rotation');
    const toggleWireframeBtn = document.getElementById('toggle-wireframe');
    const resetCameraBtn = document.getElementById('reset-camera');
    const statusContainer = document.getElementById('status-container');
    const statusText = document.getElementById('status-text');
    const spinner = document.getElementById('spinner');
    
    // Sample VRM model from CDN
    const SAMPLE_VRM_URL = 'https://cdn.jsdelivr.net/gh/pixiv/three-vrm@dev/packages/three-vrm/examples/models/VRM1_Constraint_Twist_Sample.vrm';
    
    // State
    let renderer = null;
    let isRotating = true;
    let isWireframe = false;
    
    // Show status message
    function showStatus(message, type = 'info') {
      statusText.textContent = message;
      statusContainer.style.display = 'block';
      
      // Reset classes
      statusContainer.className = 'status';
      statusContainer.classList.add(type);
      
      console.log(`[${type}] ${message}`);
      
      if (type === 'info') {
        spinner.style.display = 'inline-block';
      } else {
        spinner.style.display = 'none';
      }
    }
    
    // Hide status
    function hideStatus() {
      statusContainer.style.display = 'none';
    }
    
    // Initialize the renderer
    function initRenderer() {
      if (renderer) {
        renderer.dispose();
      }
      
      renderer = new VRMRenderer(container, {
        background: 0x212121,
        autoRotate: isRotating,
        showGrid: true,
        showAxes: true
      });
      
      // Set initial wireframe state
      renderer.setWireframe(isWireframe);
    }
    
    // Load a VRM model from URL
    function loadVRMFromUrl(url) {
      showStatus('Loading VRM model...');
      
      if (!renderer) {
        initRenderer();
      }
      
      renderer.loadVRM(
        url,
        (progress) => {
          showStatus(`Loading model: ${progress}%`);
        },
        (vrm) => {
          showStatus('Model loaded successfully!', 'success');
          setTimeout(hideStatus, 2000);
        },
        (error) => {
          showStatus(`Error loading model: ${error.message}`, 'error');
          console.error('Error details:', error);
        }
      );
    }
    
    // Load a VRM model from File
    function loadVRMFromFile(file) {
      if (!file) return;
      
      // Check if it's a VRM file
      if (!file.name.toLowerCase().endsWith('.vrm')) {
        showStatus('Please select a .vrm file', 'error');
        return;
      }
      
      showStatus(`Loading model: ${file.name}`);
      
      // Create a URL from the file
      const url = URL.createObjectURL(file);
      
      if (!renderer) {
        initRenderer();
      }
      
      renderer.loadVRM(
        url,
        (progress) => {
          showStatus(`Loading model: ${progress}%`);
        },
        (vrm) => {
          showStatus('Model loaded successfully!', 'success');
          setTimeout(hideStatus, 2000);
          
          // Clean up the object URL
          URL.revokeObjectURL(url);
        },
        (error) => {
          showStatus(`Error loading model: ${error.message}`, 'error');
          console.error('Error details:', error);
          
          // Clean up the object URL
          URL.revokeObjectURL(url);
        }
      );
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Load sample model
      loadSampleBtn.addEventListener('click', () => {
        loadVRMFromUrl(SAMPLE_VRM_URL);
      });
      
      // Load local model
      loadLocalBtn.addEventListener('click', () => {
        fileInput.click();
      });
      
      // Handle file selection
      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          loadVRMFromFile(file);
        }
        // Reset the input so the same file can be selected again
        event.target.value = '';
      });
      
      // Toggle rotation
      toggleRotationBtn.addEventListener('click', () => {
        isRotating = !isRotating;
        
        if (renderer) {
          renderer.setRotation(isRotating);
        }
        
        showStatus(`Auto-rotation: ${isRotating ? 'ON' : 'OFF'}`, 'info');
        setTimeout(hideStatus, 1000);
      });
      
      // Toggle wireframe
      toggleWireframeBtn.addEventListener('click', () => {
        isWireframe = !isWireframe;
        
        if (renderer) {
          renderer.setWireframe(isWireframe);
        }
        
        showStatus(`Wireframe mode: ${isWireframe ? 'ON' : 'OFF'}`, 'info');
        setTimeout(hideStatus, 1000);
      });
      
      // Reset camera
      resetCameraBtn.addEventListener('click', () => {
        if (renderer) {
          renderer.resetCamera();
        }
        
        showStatus('Camera reset', 'info');
        setTimeout(hideStatus, 1000);
      });
      
      // Handle drag and drop for model files
      container.addEventListener('dragover', (event) => {
        event.preventDefault();
        event.stopPropagation();
      });
      
      container.addEventListener('drop', (event) => {
        event.preventDefault();
        event.stopPropagation();
        
        const file = event.dataTransfer.files[0];
        if (file) {
          loadVRMFromFile(file);
        }
      });
    }
    
    // Initialize on page load
    window.addEventListener('load', () => {
      setupEventListeners();
      initRenderer();
      
      // Load sample model by default
      loadVRMFromUrl(SAMPLE_VRM_URL);
    });
  </script>
</body>
</html> 